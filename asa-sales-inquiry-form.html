<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ASA Sales Inquiry Form</title>
    <style>
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      html, body {
        height: 100vh;
        overflow: hidden;
        font-family: Arial, sans-serif;
        background: #f8f8f8;
      }

      .main-layout {
        display: flex;
        height: 100vh;
        width: 100vw;
      }

      /* Left panel - 40% width */
      .form-panel {
        width: 40%;
        background: white;
        padding: 20px;
        border-right: 2px solid #ddd;
        overflow-y: auto;
        overflow-x: hidden;
      }

      /* Right panel - 60% width */
      .preview-panel {
        width: 60%;
        position: relative;
        background: #f0f0f0;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 20px;
      }

      .header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid #ddd;
      }

      .header img {
        height: 50px;
        width: auto;
      }

      .header h2 {
        margin: 0;
        color: #333;
      }

      /* Form groups - labels next to inputs */
      .form-group {
        display: flex;
        align-items: center;
        margin-bottom: 12px;
        gap: 12px;
      }

      .form-group label {
        min-width: 140px;
        font-weight: 500;
        color: #555;
        font-size: 14px;
      }

      .form-group input[type="text"],
      .form-group input[type="number"] {
        flex: 1;
        padding: 8px;
        font-size: 14px;
        border: 1px solid #ccc;
        border-radius: 4px;
        background: white;
      }

      /* Textarea group - keep label on top for textarea */
      .textarea-group {
        margin-bottom: 15px;
      }

      .textarea-group label {
        display: block;
        font-weight: 500;
        color: #555;
        font-size: 14px;
        margin-bottom: 5px;
      }

      .textarea-group textarea {
        width: 100%;
        padding: 8px;
        font-size: 14px;
        border: 1px solid #ccc;
        border-radius: 4px;
        background: white;
        min-height: 80px;
        resize: vertical;
      }

      /* Checkbox group - horizontal layout */
      .checkbox-group {
        margin-bottom: 20px;
      }

      .checkbox-group > label {
        font-weight: 500;
        color: #555;
        font-size: 14px;
        margin-bottom: 8px;
        display: block;
      }

      .checkbox-container {
        display: flex;
        gap: 20px;
        flex-wrap: wrap;
      }

      .checkbox-item {
        display: flex;
        align-items: center;
      }

      .checkbox-item input[type="checkbox"] {
        margin-right: 6px;
        width: 18px;
        height: 18px;
        cursor: pointer;
      }

      .checkbox-item label {
        margin: 0;
        cursor: pointer;
        font-weight: normal;
        color: #555;
        font-size: 14px;
      }

      /* Inline input with dropdown */
      .inline-input-group {
        display: flex;
        gap: 10px;
        align-items: center;
        flex: 1;
      }

      .inline-input-group input {
        flex: 1;
      }

      .inline-input-group select {
        width: 100px;
        padding: 8px;
        font-size: 14px;
        border: 1px solid #ccc;
        border-radius: 4px;
        background: white;
      }

      /* Conditional sections */
      .conditional-section {
        display: none;
        margin-top: 15px;
        margin-bottom: 15px;
        padding: 15px;
        background: #f9f9f9;
        border-left: 3px solid #4CAF50;
        border-radius: 4px;
      }

      .conditional-section.active {
        display: block;
      }

      .conditional-section h3 {
        font-size: 16px;
        color: #333;
        margin-bottom: 15px;
        padding-bottom: 8px;
        border-bottom: 1px solid #ddd;
      }

      /* Dropdown selections */
      select {
        width: 100%;
        padding: 8px;
        font-size: 14px;
        border: 1px solid #ccc;
        border-radius: 4px;
        background: white;
      }

      /* Performance group */
      .performance-group {
        margin-top: 10px;
      }

      .performance-row {
        display: flex;
        gap: 10px;
        margin-bottom: 10px;
        align-items: center;
      }

      .performance-row label {
        min-width: 140px;
        font-weight: 500;
        color: #555;
        font-size: 14px;
      }

      .performance-row select {
        flex: 1;
      }

      /* Image upload */
      .file-upload {
        margin-bottom: 15px;
      }

      .file-upload label {
        display: block;
        font-weight: 500;
        color: #555;
        font-size: 14px;
        margin-bottom: 5px;
      }

      .file-upload input[type="file"] {
        width: 100%;
        padding: 8px;
        font-size: 14px;
        border: 1px solid #ccc;
        border-radius: 4px;
        background: white;
      }

      /* Submit button */
      .submit-btn {
        width: 100%;
        padding: 12px;
        font-size: 16px;
        font-weight: 600;
        color: white;
        background: #4CAF50;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        margin-top: 20px;
      }

      .submit-btn:hover {
        background: #45a049;
      }

      /* Preview panel content */
      .preview-content {
        text-align: center;
        color: #888;
      }

      .preview-content h3 {
        font-size: 24px;
        margin-bottom: 10px;
      }

      .preview-images {
        margin-top: 20px;
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        justify-content: center;
      }

      .preview-images img {
        max-width: 200px;
        max-height: 200px;
        border: 2px solid #ddd;
        border-radius: 4px;
      }

      /* Scrollbar styling for webkit browsers */
      .form-panel::-webkit-scrollbar {
        width: 8px;
      }

      .form-panel::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 4px;
      }

      .form-panel::-webkit-scrollbar-thumb {
        background: #c1c1c1;
        border-radius: 4px;
      }

      .form-panel::-webkit-scrollbar-thumb:hover {
        background: #a1a1a1;
      }
    </style>
  </head>
  <body>
    <div class="main-layout">
      <!-- Left Panel - Form -->
      <div class="form-panel">
        <div class="header">
          <img src="Z:\Allgemein\Temp\MA\ASA_Inquiry_form\ASA-2017-clear.png" alt="ASA Logo">
          <h2>Sales Inquiry Form</h2>
        </div>

        <form id="inquiryForm">
          <!-- Project/NOP Number -->
          <div class="form-group">
            <label for="nopNumber">Project/NOP Number:</label>
            <input type="text" id="nopNumber" name="nopNumber" required />
          </div>

          <!-- Sales Representative -->
          <div class="form-group">
            <label for="salesRep">Sales Representative:</label>
            <input type="text" id="salesRep" name="salesRep" required />
          </div>

          <!-- Customer -->
          <div class="form-group">
            <label for="customer">Customer:</label>
            <input type="text" id="customer" name="customer" required />
          </div>

          <!-- Cooler Type Checkboxes - Horizontal -->
          <div class="checkbox-group">
            <label>Cooler Type:</label>
            <div class="checkbox-container">
              <div class="checkbox-item">
                <input type="checkbox" id="oilCooler" name="coolerType" value="oil" />
                <label for="oilCooler">Oil cooler</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="waterCooler" name="coolerType" value="water" />
                <label for="waterCooler">Water cooler</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="chargeAirCooler" name="coolerType" value="chargeair" />
                <label for="chargeAirCooler">ChargeAir cooler</label>
              </div>
            </div>
          </div>

          <!-- Ambient Air Temperature with units -->
          <div class="form-group">
            <label for="ambientTemp">Ambient Air Temp.:</label>
            <div class="inline-input-group">
              <input type="number" id="ambientTemp" name="ambientTemp" step="0.1" />
              <select id="ambientTempUnit" name="ambientTempUnit">
                <option value="C">°C</option>
                <option value="F">°F</option>
              </select>
            </div>
          </div>

          <!-- Altitude with units -->
          <div class="form-group">
            <label for="altitude">Altitude:</label>
            <div class="inline-input-group">
              <input type="number" id="altitude" name="altitude" step="0.1" />
              <select id="altitudeUnit" name="altitudeUnit">
                <option value="m">m</option>
                <option value="ft">ft</option>
              </select>
            </div>
          </div>

          <!-- Fan and Count -->
          <div class="form-group">
            <label for="fan">Fan:</label>
            <input type="text" id="fan" name="fan" style="flex: 2; margin-right: 15px;" />
            <label for="fanCount" style="min-width: 60px;">Count:</label>
            <input type="number" id="fanCount" name="fanCount" value="1" style="width: 60px;" />
          </div>

          <!-- Fan Noise Level -->
          <div class="form-group">
            <label for="maxSoundLevel">Fan Noise:</label>
            <input type="number" id="maxSoundLevel" name="maxSoundLevel" style="flex: 1; margin-right: 10px;" step="0.1" />
            <select id="soundUnit" name="soundUnit" style="min-width: 80px;">
              <option value="dB(A)">dB(A)</option>
              <option value="dB">dB</option>
              <option value="sone">sone</option>
            </select>
          </div>

          <!-- Oil Cooler Section (Conditional) -->
          <div id="oilSection" class="conditional-section">
            <h3>Oil Cooler Configuration</h3>
            
            <div class="form-group">
              <label for="oilType">Oil type:</label>
              <input type="text" id="oilType" name="oilType" />
            </div>

            <div class="form-group">
              <label for="oilEntryTemp">Oil Entry Temp.:</label>
              <div class="inline-input-group">
                <input type="number" id="oilEntryTemp" name="oilEntryTemp" step="0.1" />
                <select id="oilEntryTempUnit" name="oilEntryTempUnit">
                  <option value="C">°C</option>
                  <option value="F">°F</option>
                </select>
              </div>
            </div>

            <div class="form-group">
              <label for="oilFlowrate">Flowrate:</label>
              <div class="inline-input-group">
                <input type="number" id="oilFlowrate" name="oilFlowrate" step="0.1" />
                <select id="oilFlowrateUnit" name="oilFlowrateUnit">
                  <option value="L/min">L/min</option>
                  <option value="GPM">GPM</option>
                  <option value="m3/s">m³/s</option>
                  <option value="kg/s">kg/s</option>
                  <option value="lb/s">lb/s</option>
                </select>
              </div>
            </div>

            <div class="performance-group">
              <div class="performance-row">
                <label for="oilDesiredPerf">Desired Performance:</label>
                <select id="oilDesiredPerf" name="oilDesiredPerf">
                  <option value="">Select...</option>
                  <option value="capacity">Capacity</option>
                  <option value="specific">Specific perf.</option>
                  <option value="exit">Exit temp.</option>
                </select>
                <input type="number" id="oilPerfValue" name="oilPerfValue" step="0.1" style="margin-left: 10px; flex: 1; padding: 8px; font-size: 14px; border: 1px solid #ccc; border-radius: 4px; background: white;" />
                <select id="oilPerfUnit" name="oilPerfUnit" style="margin-left: 10px; width: 120px;">
                  <option value="">Select performance first...</option>
                </select>
              </div>
            </div>
          </div>

          <!-- Water Cooler Section (Conditional) -->
          <div id="waterSection" class="conditional-section">
            <h3>Water Cooler Configuration</h3>
            
            <div class="form-group">
              <label for="medium">Medium:</label>
              <input type="text" id="medium" name="medium" value="50/50 WaterGlycol" />
            </div>

            <div class="form-group">
              <label for="waterEntryTemp">Medium Entry Temp.:</label>
              <div class="inline-input-group">
                <input type="number" id="waterEntryTemp" name="waterEntryTemp" step="0.1" />
                <select id="waterEntryTempUnit" name="waterEntryTempUnit">
                  <option value="C">°C</option>
                  <option value="F">°F</option>
                </select>
              </div>
            </div>

            <div class="form-group">
              <label for="waterFlowrate">Flowrate:</label>
              <div class="inline-input-group">
                <input type="number" id="waterFlowrate" name="waterFlowrate" step="0.1" />
                <select id="waterFlowrateUnit" name="waterFlowrateUnit">
                  <option value="L/min">L/min</option>
                  <option value="GPM">GPM</option>
                  <option value="m3/s">m³/s</option>
                  <option value="kg/s">kg/s</option>
                  <option value="lb/s">lb/s</option>
                </select>
              </div>
            </div>

            <div class="performance-group">
              <div class="performance-row">
                <label for="waterDesiredPerf">Desired Performance:</label>
                <select id="waterDesiredPerf" name="waterDesiredPerf">
                  <option value="">Select...</option>
                  <option value="capacity">Capacity</option>
                  <option value="specific">Specific perf.</option>
                  <option value="exit">Exit temp.</option>
                </select>
                <input type="number" id="waterPerfValue" name="waterPerfValue" step="0.1" style="margin-left: 10px; flex: 1; padding: 8px; font-size: 14px; border: 1px solid #ccc; border-radius: 4px; background: white;" />
                <select id="waterPerfUnit" name="waterPerfUnit" style="margin-left: 10px; width: 120px;">
                  <option value="">Select performance first...</option>
                </select>
              </div>
            </div>
          </div>

          <!-- ChargeAir Cooler Section (Conditional) -->
          <div id="chargeAirSection" class="conditional-section">
            <h3>ChargeAir Cooler Configuration</h3>
            
            <div class="form-group">
              <label for="chargeAirType">ChargeAir type:</label>
              <input type="text" id="chargeAirType" name="chargeAirType" />
            </div>

            <div class="form-group">
              <label for="chargeAirEntryTemp">ChargeAir Entry Temp.:</label>
              <div class="inline-input-group">
                <input type="number" id="chargeAirEntryTemp" name="chargeAirEntryTemp" step="0.1" />
                <select id="chargeAirEntryTempUnit" name="chargeAirEntryTempUnit">
                  <option value="C">°C</option>
                  <option value="F">°F</option>
                </select>
              </div>
            </div>

            <div class="form-group">
              <label for="chargeAirFlowrate">Flowrate:</label>
              <div class="inline-input-group">
                <input type="number" id="chargeAirFlowrate" name="chargeAirFlowrate" step="0.1" />
                <select id="chargeAirFlowrateUnit" name="chargeAirFlowrateUnit">
                  <option value="L/min">L/min</option>
                  <option value="GPM">GPM</option>
                  <option value="m3/s">m³/s</option>
                  <option value="kg/s">kg/s</option>
                  <option value="lb/s">lb/s</option>
                </select>
              </div>
            </div>

            <div class="form-group">
              <label for="chargeAirPressure">Pressure:</label>
              <div class="inline-input-group">
                <input type="number" id="chargeAirPressure" name="chargeAirPressure" step="0.1" />
                <select id="chargeAirPressureUnit" name="chargeAirPressureUnit">
                  <option value="bar">bar</option>
                  <option value="Pa">Pa</option>
                  <option value="kPa">kPa</option>
                  <option value="MPa">MPa</option>
                  <option value="mmHg">mmHg</option>
                  <option value="PSI">PSI</option>
                </select>
              </div>
            </div>

            <div class="performance-group">
              <div class="performance-row">
                <label for="chargeAirDesiredPerf">Desired Performance:</label>
                <select id="chargeAirDesiredPerf" name="chargeAirDesiredPerf">
                  <option value="">Select...</option>
                  <option value="capacity">Capacity</option>
                  <option value="specific">Specific perf.</option>
                  <option value="exit">Exit temp.</option>
                </select>
                <input type="number" id="chargeAirPerfValue" name="chargeAirPerfValue" step="0.1" style="margin-left: 10px; flex: 1; padding: 8px; font-size: 14px; border: 1px solid #ccc; border-radius: 4px; background: white;" />
                <select id="chargeAirPerfUnit" name="chargeAirPerfUnit" style="margin-left: 10px; width: 120px;">
                  <option value="">Select performance first...</option>
                </select>
              </div>
            </div>
          </div>

          <!-- Image Upload -->
          <div class="file-upload">
            <label for="images">Upload Images:</label>
            <input type="file" id="images" name="images" accept="image/*" multiple />
          </div>

          <!-- Remarks -->
          <div class="textarea-group">
            <label for="remarks">Remarks/Extra Requirements:</label>
            <textarea id="remarks" name="remarks" rows="4"></textarea>
          </div>

          <!-- Template info (read-only) -->
          <!-- Generate Buttons -->
          <div style="text-align: center; margin-top: 20px;">
            <button type="submit" class="submit-btn" style="margin-right: 10px;">Generate Inquiry</button>
          </div>
        </form>
      </div>

      <!-- Right Panel - Preview -->
      <div class="preview-panel">
        <div class="preview-content">
          <h3>Cooler Configuration</h3>
          
          <!-- Instructions label in top right -->
          <div id="instructionLabel" style="position: absolute; top: 20px; right: 20px; background: rgba(255,255,255,0.95); padding: 10px; border: 1px solid #ccc; border-radius: 6px; font-size: 12px; color: #555; max-width: 250px; text-align: left; box-shadow: 0 2px 4px rgba(0,0,0,0.1); z-index: 1000; display: none;">
            Please enter the minimum design envelope constraints (width, height, depth)<br>
            Please specify units
          </div>
          
          <div id="coolerImageContainer" style="margin: 5px 0; text-align: center; position: relative; display: inline-block;">
            <img id="coolerImage" src="" alt="Select cooler types to see configuration" style="width: 120%; height: auto; display: none; border: 2px solid #ddd; border-radius: 8px;" />
            
            <!-- Overlay text boxes for dimensions -->
            <div id="dimensionOverlay" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; display: none;">
              <!-- Common dimension boxes -->
              <input type="text" id="coolerWidthBox" class="dimension-input" placeholder="Width" style="position: absolute; width: 80px; height: 25px; font-size: 12px; text-align: center; border: 1px solid #333; background: rgba(255,255,255,0.9); pointer-events: auto;" />
              <input type="text" id="coreHeightBox" class="dimension-input" placeholder="Core H" style="position: absolute; width: 80px; height: 25px; font-size: 12px; text-align: center; border: 1px solid #333; background: rgba(255,255,255,0.9); pointer-events: auto;" />
              <input type="text" id="coolerHeightBox" class="dimension-input" placeholder="Height" style="position: absolute; width: 80px; height: 25px; font-size: 12px; text-align: center; border: 1px solid #333; background: rgba(255,255,255,0.9); pointer-events: auto;" />
              <input type="text" id="depthBox" class="dimension-input" placeholder="Depth" style="position: absolute; width: 80px; height: 25px; font-size: 12px; text-align: center; border: 1px solid #333; background: rgba(255,255,255,0.9); pointer-events: auto;" />
              
              <!-- Core width boxes (variable number) -->
              <input type="text" id="coreWidth1Box" class="dimension-input core-width" placeholder="Core W1" style="position: absolute; width: 80px; height: 25px; font-size: 12px; text-align: center; border: 1px solid #333; background: rgba(255,255,255,0.9); pointer-events: auto; display: none;" />
              <input type="text" id="coreWidth2Box" class="dimension-input core-width" placeholder="Core W2" style="position: absolute; width: 80px; height: 25px; font-size: 12px; text-align: center; border: 1px solid #333; background: rgba(255,255,255,0.9); pointer-events: auto; display: none;" />
              <input type="text" id="coreWidth3Box" class="dimension-input core-width" placeholder="Core W3" style="position: absolute; width: 80px; height: 25px; font-size: 12px; text-align: center; border: 1px solid #333; background: rgba(255,255,255,0.9); pointer-events: auto; display: none;" />
            </div>
            
            <p id="coolerImagePlaceholder" style="color: #888; font-style: italic;">Select cooler types to see configuration diagram</p>
          </div>
          <div class="preview-images" id="imagePreview"></div>
        </div>
      </div>
    </div>

    <!-- PDF Libraries -->
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <script>
      // Wait for docx to load
      function waitForDocx(callback) {
        if (window.docx) {
          callback();
        } else {
          setTimeout(() => waitForDocx(callback), 100);
        }
      }
      // Handle Oil Cooler checkbox
      document.getElementById('oilCooler').addEventListener('change', function() {
        const oilSection = document.getElementById('oilSection');
        if (this.checked) {
          oilSection.classList.add('active');
        } else {
          oilSection.classList.remove('active');
        }
        updateCoolerImage();
      });

      // Handle Water Cooler checkbox
      document.getElementById('waterCooler').addEventListener('change', function() {
        const waterSection = document.getElementById('waterSection');
        if (this.checked) {
          waterSection.classList.add('active');
        } else {
          waterSection.classList.remove('active');
        }
        updateCoolerImage();
      });

      // Handle ChargeAir Cooler checkbox
      document.getElementById('chargeAirCooler').addEventListener('change', function() {
        const chargeAirSection = document.getElementById('chargeAirSection');
        if (this.checked) {
          chargeAirSection.classList.add('active');
        } else {
          chargeAirSection.classList.remove('active');
        }
        updateCoolerImage();
      });

      // Function to update cooler configuration image
      function updateCoolerImage() {
        const oilChecked = document.getElementById('oilCooler').checked;
        const waterChecked = document.getElementById('waterCooler').checked;
        const chargeAirChecked = document.getElementById('chargeAirCooler').checked;
        
        const coolerImage = document.getElementById('coolerImage');
        const placeholder = document.getElementById('coolerImagePlaceholder');
        const overlay = document.getElementById('dimensionOverlay');
        const instructionLabel = document.getElementById('instructionLabel');
        
        let imagePath = '';
        let coreCount = 0;
        
        // Check if any cooler is selected
        const anyCoolerSelected = oilChecked || waterChecked || chargeAirChecked;
        
        // Show/hide instruction label based on selection
        if (anyCoolerSelected) {
          instructionLabel.style.display = 'block';
        } else {
          instructionLabel.style.display = 'none';
        }
        
        // Determine which image to show based on selected combinations
        if (waterChecked && oilChecked && chargeAirChecked) {
          imagePath = 'Z:\\Allgemein\\Temp\\MA\\ASA_Inquiry_form\\RAD_OC_CAC.png';
          coreCount = 3;
        } else if (waterChecked && oilChecked) {
          imagePath = 'Z:\\Allgemein\\Temp\\MA\\ASA_Inquiry_form\\RAD_OC.png';
          coreCount = 2;
        } else if (waterChecked && chargeAirChecked) {
          imagePath = 'Z:\\Allgemein\\Temp\\MA\\ASA_Inquiry_form\\RAD_CAC.png';
          coreCount = 2;
        } else if (oilChecked && chargeAirChecked) {
          imagePath = 'Z:\\Allgemein\\Temp\\MA\\ASA_Inquiry_form\\OC_CAC.png';
          coreCount = 2;
        } else if (waterChecked) {
          imagePath = 'Z:\\Allgemein\\Temp\\MA\\ASA_Inquiry_form\\RAD.png';
          coreCount = 1;
        } else if (oilChecked) {
          imagePath = 'Z:\\Allgemein\\Temp\\MA\\ASA_Inquiry_form\\OC.png';
          coreCount = 1;
        } else if (chargeAirChecked) {
          imagePath = 'Z:\\Allgemein\\Temp\\MA\\ASA_Inquiry_form\\CAC.png';
          coreCount = 1;
        }
        
        if (imagePath) {
          coolerImage.src = imagePath;
          coolerImage.style.display = 'block';
          placeholder.style.display = 'none';
          overlay.style.display = 'block';
          
          // Position dimension boxes based on configuration
          positionDimensionBoxes(coreCount, waterChecked, oilChecked, chargeAirChecked);
        } else {
          coolerImage.style.display = 'none';
          placeholder.style.display = 'block';
          overlay.style.display = 'none';
        }
      }
      
      // Function to position dimension boxes
      function positionDimensionBoxes(coreCount, water, oil, chargeAir) {
        // Hide all core width boxes first
        document.querySelectorAll('.core-width').forEach(box => box.style.display = 'none');
        
        // Common positions (approximate % from top-left of image)
        document.getElementById('coolerWidthBox').style.left = '20%';
        document.getElementById('coolerWidthBox').style.top = '82%';
        
        document.getElementById('coolerHeightBox').style.left = '100%';
        document.getElementById('coolerHeightBox').style.top = '60%';
        
        document.getElementById('coreHeightBox').style.left = '75%';
        document.getElementById('coreHeightBox').style.top = '60%';
        
        document.getElementById('depthBox').style.left = '80%';
        document.getElementById('depthBox').style.top = '20%';
        
        // Show and position core width boxes based on configuration
        if (coreCount >= 1) {
          const core1 = document.getElementById('coreWidth1Box');
          core1.style.display = 'block';
          
          if (coreCount === 1) {
            core1.style.left = '40%';
            core1.style.top = '10%';
          } else if (coreCount === 2) {
            core1.style.left = '20%';
            core1.style.top = '10%';
            
            const core2 = document.getElementById('coreWidth2Box');
            core2.style.display = 'block';
            core2.style.left = '50%';
            core2.style.top = '15%';
          } else if (coreCount === 3) {
            core1.style.left = '15%';
            core1.style.top = '10%';
            
            const core2 = document.getElementById('coreWidth2Box');
            core2.style.display = 'block';
            core2.style.left = '35%';
            core2.style.top = '20%';
            
            const core3 = document.getElementById('coreWidth3Box');
            core3.style.display = 'block';
            core3.style.left = '55%';
            core3.style.top = '30%';
          }
        }
      }

      // Handle Oil Desired Performance dropdown
      document.getElementById('oilDesiredPerf').addEventListener('change', function() {
        const perfUnit = document.getElementById('oilPerfUnit');
        perfUnit.innerHTML = '';
        
        if (this.value === 'capacity') {
          perfUnit.innerHTML = `
            <option value="kW">kW</option>
            <option value="BTU/min">BTU/min</option>
            <option value="HP">HP</option>
          `;
        } else if (this.value === 'specific') {
          perfUnit.innerHTML = `
            <option value="kW/°C">kW/°C</option>
            <option value="BTU/min.F">BTU/min.F</option>
          `;
        } else if (this.value === 'exit') {
          perfUnit.innerHTML = `
            <option value="°C">°C</option>
            <option value="°F">°F</option>
          `;
        } else {
          perfUnit.innerHTML = '<option value="">Select performance first...</option>';
        }
      });

      // Handle Water Desired Performance dropdown
      document.getElementById('waterDesiredPerf').addEventListener('change', function() {
        const perfUnit = document.getElementById('waterPerfUnit');
        perfUnit.innerHTML = '';
        
        if (this.value === 'capacity') {
          perfUnit.innerHTML = `
            <option value="kW">kW</option>
            <option value="BTU/min">BTU/min</option>
            <option value="HP">HP</option>
          `;
        } else if (this.value === 'specific') {
          perfUnit.innerHTML = `
            <option value="kW/°C">kW/°C</option>
            <option value="BTU/min.F">BTU/min.F</option>
          `;
        } else if (this.value === 'exit') {
          perfUnit.innerHTML = `
            <option value="°C">°C</option>
            <option value="°F">°F</option>
          `;
        } else {
          perfUnit.innerHTML = '<option value="">Select performance first...</option>';
        }
      });

      // Handle ChargeAir Desired Performance dropdown
      document.getElementById('chargeAirDesiredPerf').addEventListener('change', function() {
        const perfUnit = document.getElementById('chargeAirPerfUnit');
        perfUnit.innerHTML = '';
        
        if (this.value === 'capacity') {
          perfUnit.innerHTML = `
            <option value="kW">kW</option>
            <option value="BTU/min">BTU/min</option>
            <option value="HP">HP</option>
          `;
        } else if (this.value === 'specific') {
          perfUnit.innerHTML = `
            <option value="kW/°C">kW/°C</option>
            <option value="BTU/min.F">BTU/min.F</option>
          `;
        } else if (this.value === 'exit') {
          perfUnit.innerHTML = `
            <option value="°C">°C</option>
            <option value="°F">°F</option>
          `;
        } else {
          perfUnit.innerHTML = '<option value="">Select performance first...</option>';
        }
      });

      // Store uploaded images for PDF
      let uploadedImages = [];
      
      // Simple image paths (no preloading to avoid fetch issues)
      const imageUrls = {
        'logo': 'Z:\\Allgemein\\Temp\\MA\\ASA_Inquiry_form\\ASA-2017-clear.png',
        'CAC': 'Z:\\Allgemein\\Temp\\MA\\ASA_Inquiry_form\\CAC.png',
        'OC': 'Z:\\Allgemein\\Temp\\MA\\ASA_Inquiry_form\\OC.png',
        'OC_CAC': 'Z:\\Allgemein\\Temp\\MA\\ASA_Inquiry_form\\OC_CAC.png',
        'RAD': 'Z:\\Allgemein\\Temp\\MA\\ASA_Inquiry_form\\RAD.png',
        'RAD_CAC': 'Z:\\Allgemein\\Temp\\MA\\ASA_Inquiry_form\\RAD_CAC.png',
        'RAD_OC': 'Z:\\Allgemein\\Temp\\MA\\ASA_Inquiry_form\\RAD_OC.png',
        'RAD_OC_CAC': 'Z:\\Allgemein\\Temp\\MA\\ASA_Inquiry_form\\RAD_OC_CAC.png'
      };
      
      // Handle image preview
      document.getElementById('images').addEventListener('change', function(e) {
        const previewContainer = document.getElementById('imagePreview');
        previewContainer.innerHTML = '';
        uploadedImages = []; // Reset uploaded images array
        
        const files = e.target.files;
        for (let i = 0; i < files.length; i++) {
          const file = files[i];
          if (file.type.startsWith('image/')) {
            const reader = new FileReader();
            reader.onload = function(e) {
              const img = document.createElement('img');
              img.src = e.target.result;
              previewContainer.appendChild(img);
              
              // Store image data for PDF
              uploadedImages.push({
                name: file.name,
                data: e.target.result.split(',')[1], // Remove data:image/png;base64, prefix
                type: file.type
              });
            };
            reader.readAsDataURL(file);
          }
        }
      });

      // Check if libraries are available
      function waitForLibraries(callback) {
        if (typeof window.html2pdf !== 'undefined' && typeof PDFLib !== 'undefined') {
          console.log('html2pdf and PDF-lib are ready!');
          callback();
        } else {
          console.log('Waiting for libraries to load...');
          setTimeout(() => waitForLibraries(callback), 100);
        }
      }

      // Handle form submission - Generate PDF by overlaying text on template
      document.getElementById('inquiryForm').addEventListener('submit', function(e) {
        e.preventDefault();
        console.log('Form submission started...');
        
        // Wait for libraries to be available
        waitForLibraries(() => {
          try {
            generatePDFWithTemplate();
          } catch (error) {
            console.error('PDF Generation Error:', error);
            alert('Error generating PDF: ' + error.message);
          }
        });
      });

      async function generatePDFWithTemplate() {
        try {
          console.log('Starting PDF generation with template overlay...');
          
          // Get form data
          const formData = new FormData(document.getElementById('inquiryForm'));
          const coolerTypes = [];
          if (document.getElementById('oilCooler').checked) coolerTypes.push('Oil');
          if (document.getElementById('waterCooler').checked) coolerTypes.push('Water'); 
          if (document.getElementById('chargeAirCooler').checked) coolerTypes.push('ChargeAir');
          
          // Determine template based on checkboxes  
          let templateName = '';
          
          if (coolerTypes.includes('Water') && coolerTypes.includes('Oil') && coolerTypes.includes('ChargeAir')) {
            templateName = 'RAD_OC_CAC';
          } else if (coolerTypes.includes('Water') && coolerTypes.includes('Oil')) {
            templateName = 'RAD_OC';
          } else if (coolerTypes.includes('Water') && coolerTypes.includes('ChargeAir')) {
            templateName = 'RAD_CAC';
          } else if (coolerTypes.includes('Oil') && coolerTypes.includes('ChargeAir')) {
            templateName = 'OC_CAC';
          } else if (coolerTypes.includes('Water')) {
            templateName = 'RAD';
          } else if (coolerTypes.includes('Oil')) {
            templateName = 'OC';
          } else if (coolerTypes.includes('ChargeAir')) {
            templateName = 'CAC';
          } else {
            templateName = 'RAD_OC_CAC'; // Default
          }
          
          console.log(`Using template: ${templateName} from GitHub`);
          
          let pdfDoc;
          
          // Create PDF from scratch and load images from GitHub
          console.log('Creating PDF from scratch with GitHub images...');
          pdfDoc = await PDFLib.PDFDocument.create();
          const page = pdfDoc.addPage([595.28, 841.89]); // A4 size
          
          // Define fonts
          const font = await pdfDoc.embedFont(PDFLib.StandardFonts.Helvetica);
          const boldFont = await pdfDoc.embedFont(PDFLib.StandardFonts.HelveticaBold);
          const { width, height } = page.getSize();
          
          try {
            // Load ASA logo from GitHub
            const logoUrl = 'https://raw.githubusercontent.com/mo5ali/ASA_Inquiry_form/main/ASA-2017-clear.png';
            console.log('Loading ASA logo from:', logoUrl);
            const logoResponse = await fetch(logoUrl);
            console.log('Logo response status:', logoResponse.status, logoResponse.statusText);
            
            if (logoResponse.ok) {
              const logoBytes = await logoResponse.arrayBuffer();
              console.log('Logo bytes received:', logoBytes.byteLength);
              const logoImage = await pdfDoc.embedPng(logoBytes);
              
              // Add logo at top with proper aspect ratio
              const logoScale = Math.min(120 / logoImage.width, 50 / logoImage.height);
              const logoWidth = logoImage.width * logoScale;
              const logoHeight = logoImage.height * logoScale;
              
              page.drawImage(logoImage, {
                x: 50,
                y: height - 80,
                width: logoWidth,
                height: logoHeight,
              });
              console.log('✓ ASA logo loaded successfully!');
            } else {
              console.log('Could not load logo, status:', logoResponse.status);
            }
          } catch (error) {
            console.log('Error loading logo:', error.message);
            console.log('Full error:', error);
          }
          
          // Add header
          page.drawText('ASA SALES INQUIRY FORM', {
            x: 160,
            y: height - 60,
            size: 20,
            font: boldFont,
            color: PDFLib.rgb(0, 0, 0.8),
          });
          
          try {
            // Load configuration image from GitHub based on selected coolers
            let configImageUrl = '';
            if (coolerTypes.includes('Water') && coolerTypes.includes('Oil') && coolerTypes.includes('ChargeAir')) {
              configImageUrl = 'https://raw.githubusercontent.com/mo5ali/ASA_Inquiry_form/main/RAD_OC_CAC.png';
            } else if (coolerTypes.includes('Water') && coolerTypes.includes('Oil')) {
              configImageUrl = 'https://raw.githubusercontent.com/mo5ali/ASA_Inquiry_form/main/RAD_OC.png';
            } else if (coolerTypes.includes('Water') && coolerTypes.includes('ChargeAir')) {
              configImageUrl = 'https://raw.githubusercontent.com/mo5ali/ASA_Inquiry_form/main/RAD_CAC.png';
            } else if (coolerTypes.includes('Oil') && coolerTypes.includes('ChargeAir')) {
              configImageUrl = 'https://raw.githubusercontent.com/mo5ali/ASA_Inquiry_form/main/OC_CAC.png';
            } else if (coolerTypes.includes('Water')) {
              configImageUrl = 'https://raw.githubusercontent.com/mo5ali/ASA_Inquiry_form/main/RAD.png';
            } else if (coolerTypes.includes('Oil')) {
              configImageUrl = 'https://raw.githubusercontent.com/mo5ali/ASA_Inquiry_form/main/OC.png';
            } else if (coolerTypes.includes('ChargeAir')) {
              configImageUrl = 'https://raw.githubusercontent.com/mo5ali/ASA_Inquiry_form/main/CAC.png';
            }
            
            if (configImageUrl) {
              console.log(`Loading config image from: ${configImageUrl}`);
              const configResponse = await fetch(configImageUrl);
              console.log('Config image response status:', configResponse.status, configResponse.statusText);
              
              if (configResponse.ok) {
                const configBytes = await configResponse.arrayBuffer();
                console.log('Config image bytes received:', configBytes.byteLength);
                const configImage = await pdfDoc.embedPng(configBytes);
                
                // Add configuration image with proper aspect ratio
                const configScale = Math.min(250 / configImage.width, 200 / configImage.height);
                const configWidth = configImage.width * configScale;
                const configHeight = configImage.height * configScale;
                
                page.drawImage(configImage, {
                  x: 300 + (250 - configWidth) / 2, // Center horizontally in the allocated space
                  y: height - 350,
                  width: configWidth,
                  height: configHeight,
                });
                
                console.log('✓ Configuration image loaded successfully!');
              } else {
                console.log('Could not load config image, status:', configResponse.status);
                // Draw placeholder rectangle
                page.drawRectangle({
                  x: 300,
                  y: height - 350,
                  width: 250,
                  height: 200,
                  borderColor: PDFLib.rgb(0.8, 0.8, 0.8),
                  borderWidth: 2,
                  color: PDFLib.rgb(0.95, 0.95, 0.95),
                });
                
                page.drawText(`${templateName} Configuration`, {
                  x: 350,
                  y: height - 250,
                  size: 12,
                  font: boldFont,
                  color: PDFLib.rgb(0.6, 0.6, 0.6),
                });
              }
            }
          } catch (error) {
            console.log('Error loading config image:', error.message);
          }
          
          // Get the first page for text overlay
          const pages = pdfDoc.getPages();
          const firstPage = pages[0];
          
          // Apply text overlays - simple positioning for the RAD_OC_CAC template
          const textOverlays = [];
          
          // Basic project information
          let infoY = height - 150;
          
          textOverlays.push({ 
            text: 'Project Information:', 
            x: 50, 
            y: infoY, 
            size: 12, 
            font: boldFont,
            color: PDFLib.rgb(0.2, 0.2, 0.8)
          });
          infoY -= 25;
          
          if (formData.get('nopNumber')) {
            textOverlays.push({ 
              text: 'NOP Number:', 
              x: 50, y: infoY, size: 10, font: boldFont 
            });
            textOverlays.push({ 
              text: formData.get('nopNumber'), 
              x: 150, y: infoY, size: 10, font: font 
            });
            infoY -= 20;
          }
          
          if (formData.get('salesRep')) {
            textOverlays.push({ 
              text: 'Sales Rep:', 
              x: 50, y: infoY, size: 10, font: boldFont 
            });
            textOverlays.push({ 
              text: formData.get('salesRep'), 
              x: 150, y: infoY, size: 10, font: font 
            });
            infoY -= 20;
          }
          
          if (formData.get('customer')) {
            textOverlays.push({ 
              text: 'Customer:', 
              x: 50, y: infoY, size: 10, font: boldFont 
            });
            textOverlays.push({ 
              text: formData.get('customer'), 
              x: 150, y: infoY, size: 10, font: font 
            });
            infoY -= 20;
          }
          
          // Environmental conditions
          if (formData.get('ambientTemp') || formData.get('altitude')) {
            infoY -= 10;
            textOverlays.push({ 
              text: 'Environmental Conditions:', 
              x: 50, 
              y: infoY, 
              size: 12, 
              font: boldFont,
              color: PDFLib.rgb(0.2, 0.2, 0.8)
            });
            infoY -= 25;
          }
          
          if (formData.get('ambientTemp')) {
            const tempText = formData.get('ambientTemp') + ' ' + (formData.get('ambientTempUnit') || '°C');
            textOverlays.push({ 
              text: 'Ambient Temp:', 
              x: 50, y: infoY, size: 10, font: boldFont 
            });
            textOverlays.push({ 
              text: tempText, 
              x: 150, y: infoY, size: 10, font: font 
            });
            infoY -= 20;
          }
          
          if (formData.get('altitude')) {
            const altText = formData.get('altitude') + ' ' + (formData.get('altitudeUnit') || 'm');
            textOverlays.push({ 
              text: 'Altitude:', 
              x: 50, y: infoY, size: 10, font: boldFont 
            });
            textOverlays.push({ 
              text: altText, 
              x: 150, y: infoY, size: 10, font: font 
            });
            infoY -= 20;
          }
          
          // Fan information
          if (formData.get('fan')) {
            textOverlays.push({ 
              text: formData.get('fan'), 
              x: 150, y: height - 280, size: 12, font: font 
            });
          }
          
          if (formData.get('fanCount')) {
            textOverlays.push({ 
              text: formData.get('fanCount'), 
              x: 300, y: height - 280, size: 12, font: font 
            });
          }
          
          if (formData.get('maxSoundLevel')) {
            const noiseText = formData.get('maxSoundLevel') + ' ' + (formData.get('soundUnit') || 'dB(A)');
            textOverlays.push({ 
              text: noiseText, 
              x: 450, y: height - 280, size: 12, font: font 
            });
          }
          
          // Dimension overlays from the dimension boxes
          const dimensions = [
            { id: 'coolerWidthBox', x: 100, y: height - 450 },
            { id: 'coolerHeightBox', x: 500, y: height - 350 },
            { id: 'coreHeightBox', x: 450, y: height - 380 },
            { id: 'depthBox', x: 480, y: height - 200 },
            { id: 'coreWidth1Box', x: 180, y: height - 520 },
            { id: 'coreWidth2Box', x: 280, y: height - 500 },
            { id: 'coreWidth3Box', x: 380, y: height - 480 },
          ];
          
          dimensions.forEach(dim => {
            const value = document.getElementById(dim.id).value;
            if (value && value.trim()) {
              textOverlays.push({ 
                text: value, 
                x: dim.x, y: dim.y, size: 10, font: font 
              });
            }
          });
          
          // Cooler specifications
          let specY = height - 550;
          
          if (coolerTypes.includes('Oil')) {
            textOverlays.push({ 
              text: 'Oil Cooler:', 
              x: 50, 
              y: specY, 
              size: 12, 
              font: boldFont,
              color: PDFLib.rgb(0.2, 0.2, 0.8)
            });
            specY -= 20;
            
            const oilSpecs = [
              { label: 'Type', field: 'oilType' },
              { label: 'Entry Temp', field: 'oilEntryTemp', unit: 'oilEntryTempUnit' },
              { label: 'Flowrate', field: 'oilFlowrate', unit: 'oilFlowrateUnit' },
              { label: 'Performance', field: 'oilDesiredPerf' },
              { label: 'Value', field: 'oilPerfValue', unit: 'oilPerfUnit' },
            ];
            
            oilSpecs.forEach(spec => {
              const value = formData.get(spec.field);
              if (value && value.trim()) {
                const unit = spec.unit ? formData.get(spec.unit) : '';
                const text = `${spec.label}: ${value}${unit ? ' ' + unit : ''}`;
                textOverlays.push({ 
                  text: text, 
                  x: 70, 
                  y: specY, 
                  size: 10, 
                  font: font 
                });
                specY -= 15;
              }
            });
            specY -= 10;
          }
          
          if (coolerTypes.includes('Water')) {
            textOverlays.push({ 
              text: 'Water Cooler:', 
              x: 50, 
              y: specY, 
              size: 12, 
              font: boldFont,
              color: PDFLib.rgb(0.2, 0.2, 0.8)
            });
            specY -= 20;
            
            const waterSpecs = [
              { label: 'Medium', field: 'medium' },
              { label: 'Entry Temp', field: 'waterEntryTemp', unit: 'waterEntryTempUnit' },
              { label: 'Flowrate', field: 'waterFlowrate', unit: 'waterFlowrateUnit' },
              { label: 'Performance', field: 'waterDesiredPerf' },
              { label: 'Value', field: 'waterPerfValue', unit: 'waterPerfUnit' },
            ];
            
            waterSpecs.forEach(spec => {
              const value = formData.get(spec.field);
              if (value && value.trim()) {
                const unit = spec.unit ? formData.get(spec.unit) : '';
                const text = `${spec.label}: ${value}${unit ? ' ' + unit : ''}`;
                textOverlays.push({ 
                  text: text, 
                  x: 70, 
                  y: specY, 
                  size: 10, 
                  font: font 
                });
                specY -= 15;
              }
            });
            specY -= 10;
          }
          
          if (coolerTypes.includes('ChargeAir')) {
            textOverlays.push({ 
              text: 'Charge Air Cooler:', 
              x: 50, 
              y: specY, 
              size: 12, 
              font: boldFont,
              color: PDFLib.rgb(0.2, 0.2, 0.8)
            });
            specY -= 20;
            
            const chargeAirSpecs = [
              { label: 'Type', field: 'chargeAirType' },
              { label: 'Entry Temp', field: 'chargeAirEntryTemp', unit: 'chargeAirEntryTempUnit' },
              { label: 'Flowrate', field: 'chargeAirFlowrate', unit: 'chargeAirFlowrateUnit' },
              { label: 'Pressure', field: 'chargeAirPressure', unit: 'chargeAirPressureUnit' },
              { label: 'Performance', field: 'chargeAirDesiredPerf' },
              { label: 'Value', field: 'chargeAirPerfValue', unit: 'chargeAirPerfUnit' },
            ];
            
            chargeAirSpecs.forEach(spec => {
              const value = formData.get(spec.field);
              if (value && value.trim()) {
                const unit = spec.unit ? formData.get(spec.unit) : '';
                const text = `${spec.label}: ${value}${unit ? ' ' + unit : ''}`;
                textOverlays.push({ 
                  text: text, 
                  x: 70, 
                  y: specY, 
                  size: 10, 
                  font: font 
                });
                specY -= 15;
              }
            });
            specY -= 10;
          }
          
          // Add remarks if they exist
          const remarks = formData.get('remarks');
          if (remarks && remarks.trim()) {
            textOverlays.push({ 
              text: 'Remarks:', 
              x: 50, 
              y: specY, 
              size: 12, 
              font: boldFont,
              color: PDFLib.rgb(0.2, 0.2, 0.8)
            });
            specY -= 20;
            
            const remarkLines = remarks.split('\n');
            remarkLines.forEach((line, index) => {
              if (line.trim()) {
                textOverlays.push({ 
                  text: line.trim(), 
                  x: 70, 
                  y: specY - (index * 15), 
                  size: 10, 
                  font: font 
                });
              }
            });
          }
          
          // Apply all text overlays to the PDF
          textOverlays.forEach(overlay => {
            if (overlay.text && overlay.text.trim()) {
              page.drawText(overlay.text, {
                x: overlay.x,
                y: overlay.y,
                size: overlay.size,
                font: overlay.font,
                color: overlay.color || PDFLib.rgb(0, 0, 0), // Default to black text
              });
            }
          });

          // Add uploaded images as separate pages
          console.log('uploadedImages array:', uploadedImages);
          if (uploadedImages && uploadedImages.length > 0) {
            console.log(`Adding ${uploadedImages.length} uploaded images as separate pages...`);
            
            for (let i = 0; i < uploadedImages.length; i++) {
              const imageData = uploadedImages[i];
              console.log(`Processing image ${i + 1}:`, imageData.name, imageData.type);
              
              try {
                // Add new page for each image
                const imagePage = pdfDoc.addPage([595.28, 841.89]); // A4 size
                const { width: pageWidth, height: pageHeight } = imagePage.getSize();
                
                // Convert base64 to array buffer
                const imageBytes = Uint8Array.from(atob(imageData.data), c => c.charCodeAt(0));
                console.log(`Image bytes length: ${imageBytes.length}`);
                
                // Determine image type and embed accordingly
                let embedImage;
                if (imageData.type.includes('png')) {
                  embedImage = await pdfDoc.embedPng(imageBytes);
                } else if (imageData.type.includes('jpg') || imageData.type.includes('jpeg')) {
                  embedImage = await pdfDoc.embedJpg(imageBytes);
                } else {
                  console.log(`Unsupported image type: ${imageData.type}, skipping image ${i + 1}`);
                  continue;
                }
                
                console.log(`Embedded image dimensions: ${embedImage.width}x${embedImage.height}`);
                
                // Calculate scaling to fit image on page with margins
                const margin = 50;
                const maxWidth = pageWidth - (margin * 2);
                const maxHeight = pageHeight - (margin * 3); // Extra margin for title
                
                const scale = Math.min(maxWidth / embedImage.width, maxHeight / embedImage.height);
                const imageWidth = embedImage.width * scale;
                const imageHeight = embedImage.height * scale;
                
                // Center the image
                const imageX = (pageWidth - imageWidth) / 2;
                const imageY = (pageHeight - imageHeight) / 2;
                
                console.log(`Image placement: ${imageX}, ${imageY}, ${imageWidth}x${imageHeight}`);
                
                // Add title
                imagePage.drawText(`Uploaded Image ${i + 1}: ${imageData.name}`, {
                  x: margin,
                  y: pageHeight - margin,
                  size: 14,
                  font: boldFont,
                  color: PDFLib.rgb(0, 0, 0),
                });
                
                // Draw the image
                imagePage.drawImage(embedImage, {
                  x: imageX,
                  y: imageY,
                  width: imageWidth,
                  height: imageHeight,
                });
                
                console.log(`✓ Added uploaded image ${i + 1}: ${imageData.name}`);
                
              } catch (error) {
                console.error(`Error adding uploaded image ${i + 1}:`, error);
              }
            }
          } else {
            console.log('No uploaded images to add to PDF');
          }
          
          // Save the PDF
          const pdfBytes = await pdfDoc.save();
          const filename = `ASA_Inquiry_${templateName}_${(formData.get('nopNumber') || 'Draft').replace(/[^a-zA-Z0-9]/g, '_')}.pdf`;
          
          // Create download link
          const blob = new Blob([pdfBytes], { type: 'application/pdf' });
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = filename;
          a.click();
          
          window.URL.revokeObjectURL(url);
          
          console.log('✓ PDF generated successfully with template overlay!');
          alert(`✓ PDF generated successfully using ${templateName} template!`);
          
        } catch (error) {
          console.error('Template PDF generation error:', error);
          alert('Error generating PDF with template: ' + error.message + '\n\nFalling back to standard PDF generation...');
          
          // Fallback to the original method
          generatePDFWithHTML2PDF();
        }
      }

      function generatePDFWithHTML2PDF() {
        console.log('Starting html2pdf generation...');
        
        // Get form data properly
        const formData = new FormData(document.getElementById('inquiryForm'));
        const coolerTypes = [];
        if (document.getElementById('oilCooler').checked) coolerTypes.push('Oil');
        if (document.getElementById('waterCooler').checked) coolerTypes.push('Water');
        if (document.getElementById('chargeAirCooler').checked) coolerTypes.push('ChargeAir');
        
        // Get actual logo source from page
        const logoImg = document.querySelector('img[alt*="ASA"]');
        const logoSrc = logoImg ? logoImg.src : '';
        console.log('Logo source:', logoSrc);
        
        // Get actual cooler config image source from page
        const coolerImg = document.getElementById('coolerImage');
        const coolerSrc = coolerImg && coolerImg.src && !coolerImg.src.includes('placeholder') ? coolerImg.src : '';
        console.log('Cooler image source:', coolerSrc);
        
        // Get user uploaded images
        const uploadedImages = document.querySelectorAll('.uploaded-image img');
        console.log('Found uploaded images:', uploadedImages.length);
        
        // Create HTML content for PDF
        const pdfContent = document.createElement('div');
        pdfContent.style.padding = '20px';
        pdfContent.style.fontFamily = 'Arial, sans-serif';
        pdfContent.style.fontSize = '12px';
        pdfContent.style.lineHeight = '1.4';
        pdfContent.style.color = '#000';
        pdfContent.style.backgroundColor = '#fff';
        
        pdfContent.innerHTML = `
          <div style="text-align: center; margin-bottom: 30px;">
            ${logoSrc ? `<img src="${logoSrc}" alt="ASA Logo" style="height: 40px; margin-bottom: 10px;">` : '<div style="font-weight: bold; font-size: 18px; margin-bottom: 10px;">ASA</div>'}
            <h1 style="margin: 10px 0; font-size: 24px;">Sales Inquiry Form</h1>
          </div>
          
          <div style="margin-bottom: 20px;">
            <h3 style="color: #333; border-bottom: 1px solid #ccc; padding-bottom: 5px;">Project Information</h3>
            <table style="width: 100%; border-collapse: collapse;">
              <tr><td style="padding: 5px;"><strong>Project/NOP:</strong></td><td style="padding: 5px;">${formData.get('nopNumber') || 'N/A'}</td></tr>
              <tr><td style="padding: 5px;"><strong>Sales Rep:</strong></td><td style="padding: 5px;">${formData.get('salesRep') || 'N/A'}</td></tr>
              <tr><td style="padding: 5px;"><strong>Customer:</strong></td><td style="padding: 5px;">${formData.get('customer') || 'N/A'}</td></tr>
              <tr><td style="padding: 5px;"><strong>Project Type:</strong></td><td style="padding: 5px;">${formData.get('projectType') || 'N/A'}</td></tr>
              <tr><td style="padding: 5px;"><strong>Ambient Temperature:</strong></td><td style="padding: 5px;">${formData.get('ambientTemp') || 'N/A'}°C</td></tr>
              <tr><td style="padding: 5px;"><strong>Altitude:</strong></td><td style="padding: 5px;">${formData.get('altitude') || 'N/A'}m</td></tr>
              <tr><td style="padding: 5px;"><strong>Fan Noise:</strong></td><td style="padding: 5px;">${formData.get('maxSoundLevel') || 'N/A'} ${formData.get('soundUnit') || 'dB(A)'}</td></tr>
              <tr><td style="padding: 5px;"><strong>Fan:</strong></td><td style="padding: 5px;">${formData.get('fan') || 'N/A'}</td></tr>
              <tr><td style="padding: 5px;"><strong>Fan Count:</strong></td><td style="padding: 5px;">${formData.get('fanCount') || '1'}</td></tr>
            </table>
          </div>
          
          ${coolerTypes.length > 0 ? `
          <div style="margin-bottom: 20px;">
            <h3 style="color: #333; border-bottom: 1px solid #ccc; padding-bottom: 5px;">Cooler Configuration: ${coolerTypes.join(' + ')}</h3>
            ${coolerSrc ? `
              <div style="text-align: center; margin: 20px 0;">
                <img src="${coolerSrc}" alt="Cooler Configuration" style="max-width: 100%; height: auto;">
              </div>
            ` : `
              <div style="text-align: center; padding: 40px; border: 2px dashed #ccc; margin: 20px 0; color: #666;">
                Cooler Configuration: ${coolerTypes.join(' + ')}
              </div>
            `}
            <table style="width: 100%; border-collapse: collapse;">
              ${coolerTypes.includes('Oil') ? `<tr><td style="padding: 5px;"><strong>Oil Flow Rate:</strong></td><td style="padding: 5px;">${formData.get('oilFlowRate') || 'N/A'} l/min</td></tr>` : ''}
              ${coolerTypes.includes('Water') ? `<tr><td style="padding: 5px;"><strong>Water Flow Rate:</strong></td><td style="padding: 5px;">${formData.get('waterFlowRate') || 'N/A'} l/min</td></tr>` : ''}
              ${coolerTypes.includes('ChargeAir') ? `<tr><td style="padding: 5px;"><strong>Charge Air Fans:</strong></td><td style="padding: 5px;">${formData.get('chargeAirFans') || 'N/A'}</td></tr>` : ''}
              ${coolerTypes.includes('ChargeAir') ? `<tr><td style="padding: 5px;"><strong>Charge Air Count:</strong></td><td style="padding: 5px;">${formData.get('chargeAirCount') || 'N/A'}</td></tr>` : ''}
            </table>
          </div>
          ` : ''}
          
          ${uploadedImages.length > 0 ? `
          <div style="margin-bottom: 20px; page-break-before: avoid;">
            <h3 style="color: #333; border-bottom: 1px solid #ccc; padding-bottom: 5px;">Uploaded Images (${uploadedImages.length})</h3>
            ${Array.from(uploadedImages).map((img, index) => `
              <div style="margin: 15px 0; text-align: center; page-break-inside: avoid;">
                <img src="${img.src}" alt="Uploaded Image ${index + 1}" style="max-width: 90%; max-height: 250px; border: 1px solid #ddd;">
                <p style="margin-top: 5px; font-size: 10px; color: #666;">Image ${index + 1}</p>
              </div>
            `).join('')}
          </div>
          ` : ''}
          
          ${formData.get('remarks') ? `
          <div style="margin-bottom: 20px;">
            <h3 style="color: #333; border-bottom: 1px solid #ccc; padding-bottom: 5px;">Remarks</h3>
            <div style="white-space: pre-wrap; padding: 10px; background: #f9f9f9; border: 1px solid #eee;">${formData.get('remarks')}</div>
          </div>
          ` : ''}
        `;
        
        // Log what we're trying to generate
        console.log('PDF Content created with:');
        console.log('- Logo:', logoSrc ? 'YES' : 'NO');
        console.log('- Cooler image:', coolerSrc ? 'YES' : 'NO'); 
        console.log('- User images:', uploadedImages.length);
        console.log('- Cooler types:', coolerTypes);
        console.log('- Form data keys:', Array.from(formData.keys()));
        
        // Configure html2pdf options with CORS workaround
        const opt = {
          margin: 10,
          filename: 'ASA_Inquiry_' + (formData.get('nopNumber') || 'Draft').replace(/[^a-zA-Z0-9]/g, '_') + '.pdf',
          image: { type: 'jpeg', quality: 0.9 },
          html2canvas: { 
            scale: 1.5,
            useCORS: false,
            allowTaint: false,
            logging: true,
            backgroundColor: '#ffffff',
            onclone: function(clonedDoc) {
              // Only remove problematic local file images, keep user uploaded images
              const images = clonedDoc.querySelectorAll('img');
              images.forEach(img => {
                const src = img.src || '';
                // Only replace local file path images (not base64, blob, or data URLs)
                if (src.startsWith('file://') || src.match(/^[A-Z]:\\/)) {
                  console.log('Removing problematic local file image:', src);
                  const placeholder = clonedDoc.createElement('div');
                  placeholder.style.cssText = 'width: 200px; height: 100px; border: 2px dashed #666; display: flex; align-items: center; justify-content: center; margin: 10px auto; color: #666; font-size: 12px; background: #f9f9f9;';
                  placeholder.textContent = img.alt || 'Local Image';
                  img.parentNode.replaceChild(placeholder, img);
                } else if (src.startsWith('data:') || src.startsWith('blob:')) {
                  console.log('Keeping user uploaded image:', src.substring(0, 50) + '...');
                  // Keep user uploaded images as they should work fine
                }
              });
            }
          },
          jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
        };
        
        // Generate PDF
        html2pdf().set(opt).from(pdfContent).save()
          .then(() => {
            console.log('✓ PDF generated successfully with html2pdf!');
            alert('✓ PDF generated successfully!');
          })
          .catch(error => {
            console.error('html2pdf error:', error);
            alert('Error generating PDF: ' + error.message);
          });
      }
      
      function sendEmail() {
        console.log('Launching Outlook email...');
        
        // Get form data
        const formData = new FormData(document.getElementById('inquiryForm'));
        const coolerTypes = [];
        if (document.getElementById('oilCooler').checked) coolerTypes.push('Oil');
        if (document.getElementById('waterCooler').checked) coolerTypes.push('Water');
        if (document.getElementById('chargeAirCooler').checked) coolerTypes.push('ChargeAir');
        
        const uploadedImages = document.querySelectorAll('.uploaded-image img');
        
        // Email details
        const subject = encodeURIComponent(`ASA Sales Inquiry - ${formData.get('nopNumber') || 'New Project'}`);
        
        const body = encodeURIComponent(`
ASA SALES INQUIRY FORM
======================

PROJECT INFORMATION:
- Project/NOP: ${formData.get('nopNumber') || 'N/A'}
- Sales Rep: ${formData.get('salesRep') || 'N/A'}
- Customer: ${formData.get('customer') || 'N/A'}
- Project Type: ${formData.get('projectType') || 'N/A'}
- Ambient Temperature: ${formData.get('ambientTemp') || 'N/A'}°C
- Altitude: ${formData.get('altitude') || 'N/A'}m
- Fan Noise: ${formData.get('maxSoundLevel') || 'N/A'} ${formData.get('soundUnit') || 'dB(A)'}
- Fan: ${formData.get('fan') || 'N/A'}
- Fan Count: ${formData.get('fanCount') || '1'}

COOLER CONFIGURATION:
- Selected Coolers: ${coolerTypes.length > 0 ? coolerTypes.join(' + ') : 'None selected'}
${coolerTypes.includes('Oil') ? `- Oil Flow Rate: ${formData.get('oilFlowRate') || 'N/A'} l/min` : ''}
${coolerTypes.includes('Water') ? `- Water Flow Rate: ${formData.get('waterFlowRate') || 'N/A'} l/min` : ''}
${coolerTypes.includes('ChargeAir') ? `- Charge Air Fans: ${formData.get('chargeAirFans') || 'N/A'}, Count: ${formData.get('chargeAirCount') || 'N/A'}` : ''}

${formData.get('remarks') ? `REMARKS:
${formData.get('remarks')}` : ''}

IMAGES:
${uploadedImages.length > 0 ? `- ${uploadedImages.length} image(s) uploaded (please find attached)` : '- No images uploaded'}

Note: Please manually attach any uploaded images and cooler configuration diagrams as needed.
        `.trim());
        
        // Launch Outlook
        const mailtoLink = `mailto:?subject=${subject}&body=${body}`;
        
        try {
          window.location.href = mailtoLink;
          alert(`✓ Outlook launched successfully!\n\nNext steps:\n1. Add recipient email address\n2. Manually attach uploaded images if any\n3. Attach cooler configuration diagrams\n4. Send email`);
        } catch (error) {
          console.error('Failed to launch Outlook:', error);
          
          // Fallback - copy to clipboard
          const fullText = decodeURIComponent(body);
          navigator.clipboard.writeText(fullText).then(() => {
            alert('✓ Email content copied to clipboard!\n\nNext steps:\n1. Open Outlook manually\n2. Paste this content\n3. Add recipient and attachments');
          }).catch(() => {
            alert('Email details:\n\nSubject: ' + decodeURIComponent(subject) + '\n\n' + decodeURIComponent(body).substring(0, 500) + '...');
          });
        }
      }
      
      function generateWordDocument() {
        // Access docx properly
        const Document = docx.Document;
        const Packer = docx.Packer;
        const Paragraph = docx.Paragraph;
        const TextRun = docx.TextRun;
        const ImageRun = docx.ImageRun;
        const HeadingLevel = docx.HeadingLevel;
        
        // Collect form data
        const formData = new FormData(document.getElementById('inquiryForm'));
        
        // Get selected cooler types
        const coolerTypes = [];
        if (document.getElementById('oilCooler').checked) coolerTypes.push('Oil Cooler');
        if (document.getElementById('waterCooler').checked) coolerTypes.push('Water Cooler');
        if (document.getElementById('chargeAirCooler').checked) coolerTypes.push('ChargeAir Cooler');
        
        const children = [];
        
        // Title with ASA text (no logo for now to avoid fetch issues)
        children.push(
          new Paragraph({
            children: [new TextRun("ASA - Sales Inquiry Form")],
            heading: HeadingLevel.TITLE,
            alignment: "center"
          })
        );
        
        // Project Information
        children.push(
          new Paragraph({
            text: "Project Information",
            heading: HeadingLevel.HEADING_1
          })
        );
        
        const projectInfo = [
          'Project/NOP: ' + (formData.get('nopNumber') || 'Not specified'),
          'Sales Rep: ' + (formData.get('salesRep') || 'Not specified'),
          'Customer: ' + (formData.get('customer') || 'Not specified'),
          'Cooler Types: ' + (coolerTypes.length ? coolerTypes.join(', ') : 'None selected'),
          'Ambient Temp: ' + (formData.get('ambientTemp') || 'Not specified') + ' ' + (formData.get('ambientTempUnit') || ''),
          'Altitude: ' + (formData.get('altitude') || 'Not specified') + ' ' + (formData.get('altitudeUnit') || ''),
          'Fan: ' + (formData.get('fan') || 'Not specified'),
          'Fan Count: ' + (formData.get('fanCount') || 'Not specified')
        ];
        
        projectInfo.forEach(line => {
          children.push(
            new Paragraph({
              children: [new TextRun(line)]
            })
          );
        });
        
        // Design Constraints
        children.push(
          new Paragraph({
            text: "Design Envelope Constraints",
            heading: HeadingLevel.HEADING_1
          })
        );
        
        const dimensions = [
          'Cooler Width: ' + (document.getElementById('coolerWidthBox').value || 'Not specified'),
          'Cooler Height: ' + (document.getElementById('coolerHeightBox').value || 'Not specified'),
          'Core Height: ' + (document.getElementById('coreHeightBox').value || 'Not specified'),
          'Depth: ' + (document.getElementById('depthBox').value || 'Not specified')
        ];
        
        // Add core widths if they have values
        const core1 = document.getElementById('coreWidth1Box').value;
        const core2 = document.getElementById('coreWidth2Box').value;
        const core3 = document.getElementById('coreWidth3Box').value;
        
        if (core1) dimensions.push('Core Width 1: ' + core1);
        if (core2) dimensions.push('Core Width 2: ' + core2);
        if (core3) dimensions.push('Core Width 3: ' + core3);
        
        dimensions.forEach(line => {
          children.push(
            new Paragraph({
              children: [new TextRun(line)]
            })
          );
        });
        
        // Add cooler configuration info (text only for now)
        const configType = getConfigurationName(coolerTypes).replace(' configuration', '');
        
        if (coolerTypes.length > 0) {
          children.push(
            new Paragraph({
              children: [new TextRun("Cooler Configuration")],
              heading: HeadingLevel.HEADING_1
            })
          );
          
          children.push(
            new Paragraph({
              children: [new TextRun('Configuration: ' + getConfigurationName(coolerTypes))]
            })
          );
          
          children.push(
            new Paragraph({
              children: [new TextRun('Configuration diagram: ' + configType + ' (see attached files)')]
            })
          );
        }
        
        // Add cooler configurations
        if (document.getElementById('oilCooler').checked) {
          addCoolerConfigToWord(children, 'Oil Cooler Configuration', {
            'Oil Type': formData.get('oilType'),
            'Entry Temp': (formData.get('oilEntryTemp') || '') + ' ' + (formData.get('oilEntryTempUnit') || ''),
            'Flowrate': (formData.get('oilFlowrate') || '') + ' ' + (formData.get('oilFlowrateUnit') || ''),
            'Performance': formData.get('oilDesiredPerf'),
            'Performance Value': (formData.get('oilPerfValue') || '') + ' ' + (formData.get('oilPerfUnit') || '')
          }, Paragraph, TextRun, HeadingLevel);
        }
        
        if (document.getElementById('waterCooler').checked) {
          addCoolerConfigToWord(children, 'Water Cooler Configuration', {
            'Medium': formData.get('medium'),
            'Entry Temp': (formData.get('waterEntryTemp') || '') + ' ' + (formData.get('waterEntryTempUnit') || ''),
            'Flowrate': (formData.get('waterFlowrate') || '') + ' ' + (formData.get('waterFlowrateUnit') || ''),
            'Performance': formData.get('waterDesiredPerf'),
            'Performance Value': (formData.get('waterPerfValue') || '') + ' ' + (formData.get('waterPerfUnit') || '')
          }, Paragraph, TextRun, HeadingLevel);
        }
        
        if (document.getElementById('chargeAirCooler').checked) {
          addCoolerConfigToWord(children, 'ChargeAir Cooler Configuration', {
            'ChargeAir Type': formData.get('chargeAirType'),
            'Entry Temp': (formData.get('chargeAirEntryTemp') || '') + ' ' + (formData.get('chargeAirEntryTempUnit') || ''),
            'Flowrate': (formData.get('chargeAirFlowrate') || '') + ' ' + (formData.get('chargeAirFlowrateUnit') || ''),
            'Pressure': (formData.get('chargeAirPressure') || '') + ' ' + (formData.get('chargeAirPressureUnit') || ''),
            'Performance': formData.get('chargeAirDesiredPerf'),
            'Performance Value': (formData.get('chargeAirPerfValue') || '') + ' ' + (formData.get('chargeAirPerfUnit') || '')
          }, Paragraph, TextRun, HeadingLevel);
        }
        
        // Remarks
        const remarks = formData.get('remarks');
        if (remarks && remarks.trim()) {
          children.push(
            new Paragraph({
              text: "Remarks",
              heading: HeadingLevel.HEADING_1
            })
          );
          
          children.push(
            new Paragraph({
              children: [new TextRun(remarks)]
            })
          );
        }
        
        // Add uploaded images
        if (uploadedImages.length > 0) {
          children.push(
            new Paragraph({
              children: [new TextRun("Uploaded Images")],
              heading: HeadingLevel.HEADING_1
            })
          );
          
          uploadedImages.forEach((imageData, index) => {
            try {
              const imageBlob = base64ToBlob(imageData.data);
              children.push(
                new Paragraph({
                  children: [new TextRun(`Image ${index + 1}: ${imageData.name}`)]
                })
              );
              
              children.push(
                new Paragraph({
                  children: [
                    new ImageRun({
                      data: imageBlob,
                      transformation: {
                        width: 400,
                        height: 300,
                      },
                    }),
                  ],
                })
              );
            } catch (error) {
              console.error('Error adding uploaded image to Word doc:', error);
              children.push(
                new Paragraph({
                  children: [new TextRun(`Error: Could not add image ${imageData.name}`)]
                })
              );
            }
          });
        }
        
        // Create document
        const doc = new Document({
          sections: [{
            properties: {},
            children: children
          }]
        });
        
        // Save document
        Packer.toBlob(doc).then(blob => {
          const projectNumber = formData.get('nopNumber') || 'Unknown';
          const filename = `ASA_Inquiry_${projectNumber.replace(/[^a-zA-Z0-9]/g, '_')}.docx`;
          
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = filename;
          a.click();
          
          window.URL.revokeObjectURL(url);
          alert('Word document generated successfully!');
        }).catch(error => {
          console.error('Error saving Word document:', error);
          alert('Error saving Word document: ' + error.message);
        });
      }
      
      // Helper function to convert base64 to blob
      function base64ToBlob(base64, mimeType = 'image/png') {
        const byteCharacters = atob(base64.split(',')[1]);
        const byteNumbers = new Array(byteCharacters.length);
        for (let i = 0; i < byteCharacters.length; i++) {
          byteNumbers[i] = byteCharacters.charCodeAt(i);
        }
        const byteArray = new Uint8Array(byteNumbers);
        return new Blob([byteArray], { type: mimeType });
      }
      
      // Helper function to add cooler config to Word document
      function addCoolerConfigToWord(children, title, config, Paragraph, TextRun, HeadingLevel) {
        children.push(
          new Paragraph({
            children: [new TextRun(title)],
            heading: HeadingLevel.HEADING_2
          })
        );
        
        Object.entries(config).forEach(([key, value]) => {
          if (value && value.trim() && value !== ' ') {
            children.push(
              new Paragraph({
                children: [new TextRun(`${key}: ${value}`)]
              })
            );
          }
        });
      }
      
      function getConfigurationName(coolerTypes) {
        if (coolerTypes.length === 3) return 'RAD_OC_CAC configuration';
        if (coolerTypes.includes('Water Cooler') && coolerTypes.includes('Oil Cooler')) return 'RAD_OC configuration';
        if (coolerTypes.includes('Water Cooler') && coolerTypes.includes('ChargeAir Cooler')) return 'RAD_CAC configuration';
        if (coolerTypes.includes('Oil Cooler') && coolerTypes.includes('ChargeAir Cooler')) return 'OC_CAC configuration';
        if (coolerTypes.includes('Water Cooler')) return 'RAD configuration';
        if (coolerTypes.includes('Oil Cooler')) return 'OC configuration';
        if (coolerTypes.includes('ChargeAir Cooler')) return 'CAC configuration';
        return 'No configuration selected';
      }
    </script>
  </body>
</html>